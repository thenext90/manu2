name: Daily News Update

permissions:
  contents: write
  actions: read

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update'
        required: false
        default: false
        type: boolean

jobs:
  update-daily-news:
    runs-on: ubuntu-latest
    name: Generate Daily News
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq
        
    - name: Generate daily news
      run: |
        echo "Generating 3 random articles..."
        
        SOURCE_FILE="isotools-summaries-standalone/isotools-final-data.json"
        OUTPUT_FILE="isotools-daily-news.json"
        
        if [ ! -f "$SOURCE_FILE" ]; then
          echo "Error: $SOURCE_FILE not found"
          exit 1
        fi
        
        TODAY=$(date +'%Y-%m-%d')
        TOMORROW=$(date -d '+1 day' +'%Y-%m-%d')
        CURRENT_ISO=$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
        
        echo "Date: $TODAY"
        echo "Processing: $SOURCE_FILE"
        
        SELECTED_ARTICLES=$(jq '.data | sort_by(now * 1000 | tostring | tonumber) | .[0:3] | to_entries | map(.value + {"news_priority": (.key + 1), "selected_date": "'$CURRENT_ISO'", "rotation_id": ("'$TODAY'-" + (.key + 1 | tostring))}) | map(.value)' "$SOURCE_FILE")
        
        ORIGINAL_SOURCE=$(jq -r '.metadata.source // "ISOTools Corporate Blog"' "$SOURCE_FILE")
        TOTAL_ARTICLES=$(jq -r '.data | length' "$SOURCE_FILE")
        
        jq -n --arg today "$TODAY" --arg tomorrow "$TOMORROW" --arg current_iso "$CURRENT_ISO" --arg original_source "$ORIGINAL_SOURCE" --arg total_articles "$TOTAL_ARTICLES" --arg repo "${{ github.repository }}" --argjson selected_articles "$SELECTED_ARTICLES" '{metadata: {title: "ISOTools - Noticias Diarias", description: "Seleccion diaria de 3 articulos destacados sobre normas ISO", source: "ISOTools Corporate Blog (isotools.us)", generated_date: $today, generated_at: $current_iso, next_update: $tomorrow, total_articles: 3, rotation_type: "daily_random_selection", version: "1.0.0", purpose: "Noticias diarias para seccion web", github_raw_example: ("https://raw.githubusercontent.com/" + $repo + "/main/isotools-daily-news.json"), parent_source: $original_source, language: "espanol"}, configuration: {daily_rotation: true, articles_per_day: 3, selection_method: "timestamp_based_random_with_jq", auto_update: true, github_action_enabled: true, cache_duration_hours: 24, rotation_on_each_execution: true}, daily_news: $selected_articles, generation_info: {selected_at: $current_iso, next_rotation: ($tomorrow + "T12:00:00.000Z"), algorithm: "jq_timestamp_sort_selection", total_available_articles: ($total_articles | tonumber), rotation_guaranteed: true}}' > "$OUTPUT_FILE"
        
        if [ -f "$OUTPUT_FILE" ]; then
          echo "File generated successfully"
          jq -r '.daily_news[] | "\(.news_priority). \(.title[0:60])..."' "$OUTPUT_FILE"
          cp "$OUTPUT_FILE" "isotools-summaries-standalone/"
          echo "File copied to subdirectory"
        else
          echo "Error generating file"
          exit 1
        fi
        
    - name: Get date
      id: date
      run: echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes"
        else
          git add isotools-daily-news.json
          git add isotools-summaries-standalone/isotools-daily-news.json
          git commit -m "Daily news updated - ${{ steps.date.outputs.TODAY }}"
          git push origin main
          echo "Changes pushed"
        fi
        
    - name: Summary
      run: |
        echo "Update completed for ${{ steps.date.outputs.TODAY }}"
        echo "RAW URL: https://raw.githubusercontent.com/${{ github.repository }}/main/isotools-daily-news.json"
