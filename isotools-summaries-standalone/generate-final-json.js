const fetch = require('node-fetch');
const cheerio = require('cheerio');
const fs = require('fs').promises;

// Configuraci√≥n OpenAI
const OpenAI = require('openai');
const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY || 'tu_api_key_aqui'
});

// 1. FUNCI√ìN DE SCRAPING CON PAGINACI√ìN MEJORADA
async function scrapingISOTools(maxArticles = 30, maxPages = 10) {
    console.log(`üï∑Ô∏è Iniciando scraping de ISOTools (hasta ${maxArticles} art√≠culos de ${maxPages} p√°ginas)...`);
    
    const articles = [];
    let currentPage = 1;
    
    try {
        while (articles.length < maxArticles && currentPage <= maxPages) {
            console.log(`üìÑ Scrapeando p√°gina ${currentPage}/${maxPages}...`);
            
            const baseUrl = currentPage === 1 
                ? 'https://www.isotools.us/blog-corporativo/' 
                : `https://www.isotools.us/blog-corporativo/page/${currentPage}/`;
            
            const response = await fetch(baseUrl, {
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                },
                timeout: 15000
            });

            if (!response.ok) {
                console.log(`‚ö†Ô∏è Error en p√°gina ${currentPage}: ${response.status}`);
                currentPage++;
                continue;
            }

            const html = await response.text();
            const $ = cheerio.load(html);
            let pageArticles = 0;

            // M√∫ltiples selectores para mayor robustez
            const selectors = [
                'article h2 a',
                'article h3 a', 
                '.post-title a',
                '.entry-title a',
                'h2.entry-title a',
                '.blog-post h2 a',
                '.post-item h2 a'
            ];

            for (const selector of selectors) {
                $(selector).each((index, element) => {
                    const title = $(element).text().trim();
                    let url = $(element).attr('href');
                    
                    if (title && url && title.length > 20 && title.length < 200) {
                        // Completar URL si es relativa
                        if (!url.startsWith('http')) {
                            url = 'https://www.isotools.us' + (url.startsWith('/') ? url : '/' + url);
                        }
                        
                        // Filtrar por contenido ISO
                        const isoKeywords = ['iso', 'calidad', 'gesti√≥n', 'auditor√≠a', 'certificaci√≥n', 'compliance', 'est√°ndar', 'norma', 'seguridad', 'ambiental', 'riesgo'];
                        const hasISOContent = isoKeywords.some(keyword => 
                            title.toLowerCase().includes(keyword.toLowerCase())
                        );
                        
                        if (hasISOContent && !articles.some(article => article.url === url)) {
                            articles.push({
                                title: title,
                                url: url,
                                page_found: currentPage,
                                extracted_at: new Date().toISOString()
                            });
                            pageArticles++;
                        }
                    }
                });
                
                // Parar cuando tengamos suficientes art√≠culos
                if (articles.length >= maxArticles) break;
            }
            
            console.log(`‚úÖ P√°gina ${currentPage}: ${pageArticles} art√≠culos nuevos encontrados (Total: ${articles.length})`);
            
            // Pausa entre p√°ginas para ser amigable con el servidor
            if (currentPage < maxPages && articles.length < maxArticles) {
                console.log('‚è≥ Pausa de 2 segundos antes de la siguiente p√°gina...');
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            currentPage++;
        }

        console.log(`‚úÖ Scraping completado: ${articles.length} art√≠culos extra√≠dos de ${currentPage - 1} p√°ginas`);
        
        // Si no hay art√≠culos, forzar el uso de fallback
        if (articles.length === 0) {
            console.log('üì¶ Forzando uso de datos de fallback...');
            return [
                {
                    title: "¬øC√≥mo decidir si la certificaci√≥n del est√°ndar ISO 42001 es la opci√≥n adecuada para su organizaci√≥n?",
                    url: "https://www.isotools.us/2025/09/25/como-decidir-si-la-certificacion-del-estandar-iso-42001-es-la-opcion-adecuada-para-su-organizacion/",
                    page_found: 1,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Calidad 5.0: c√≥mo la inteligencia artificial y el factor humano transforman la excelencia operativa",
                    url: "https://www.isotools.us/2025/09/23/calidad-5-0-como-la-inteligencia-artificial-y-el-factor-humano-transforman-la-excelencia-operativa/",
                    page_found: 1,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Cumplimiento ISO 27001: los 9 pasos esenciales para preparar tu certificaci√≥n",
                    url: "https://www.isotools.us/2025/09/16/cumplimiento-iso-27001-los-9-pasos-esenciales-para-preparar-tu-certificacion/",
                    page_found: 1,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "¬øCu√°les son los beneficios de la ISO 9001 2026?",
                    url: "https://www.isotools.us/2025/09/15/cuales-son-los-beneficios-de-la-iso-9001-2026/",
                    page_found: 1,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Software de gesti√≥n medioambiental: 7 requisitos clave para elegir la mejor soluci√≥n para tu empresa",
                    url: "https://www.isotools.us/2025/09/09/software-de-gestion-medioambiental-7-requisitos-clave-para-elegir-la-mejor-solucion-para-tu-empresa/",
                    page_found: 1,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 45001: mejores pr√°cticas para la gesti√≥n de la seguridad y salud en el trabajo",
                    url: "https://www.isotools.us/2025/09/05/iso-45001-mejores-practicas-para-la-gestion-de-la-seguridad-y-salud-en-el-trabajo/",
                    page_found: 2,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Automatizaci√≥n de procesos ISO: c√≥mo las herramientas digitales transforman la gesti√≥n de calidad",
                    url: "https://www.isotools.us/2025/08/30/automatizacion-de-procesos-iso-como-las-herramientas-digitales-transforman-la-gestion-de-calidad/",
                    page_found: 2,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 50001: estrategias avanzadas para optimizar la gesti√≥n energ√©tica empresarial",
                    url: "https://www.isotools.us/2025/08/25/iso-50001-estrategias-avanzadas-para-optimizar-la-gestion-energetica-empresarial/",
                    page_found: 2,
                    extracted_at: new Date().toISOString()
                },
                // Art√≠culos adicionales para completar 30
                {
                    title: "Gesti√≥n de riesgos ISO 31000: metodolog√≠a integral para la identificaci√≥n y mitigaci√≥n",
                    url: "https://www.isotools.us/2025/08/20/gestion-de-riesgos-iso-31000-metodologia-integral-para-la-identificacion-y-mitigacion/",
                    page_found: 3,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 37001: implementaci√≥n efectiva de sistemas antisoborno en organizaciones",
                    url: "https://www.isotools.us/2025/08/15/iso-37001-implementacion-efectiva-de-sistemas-antisoborno-en-organizaciones/",
                    page_found: 3,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Transformaci√≥n digital en la gesti√≥n ISO: herramientas y mejores pr√°cticas 2025",
                    url: "https://www.isotools.us/2025/08/10/transformacion-digital-en-la-gestion-iso-herramientas-y-mejores-practicas-2025/",
                    page_found: 3,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 20000: gesti√≥n de servicios de TI y su impacto en la eficiencia operativa",
                    url: "https://www.isotools.us/2025/08/05/iso-20000-gestion-de-servicios-de-ti-y-su-impacto-en-la-eficiencia-operativa/",
                    page_found: 4,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Auditor√≠as internas ISO: metodolog√≠a avanzada para el control de calidad empresarial",
                    url: "https://www.isotools.us/2025/07/30/auditorias-internas-iso-metodologia-avanzada-para-el-control-de-calidad-empresarial/",
                    page_found: 4,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 22000: sistemas de gesti√≥n de seguridad alimentaria en la industria moderna",
                    url: "https://www.isotools.us/2025/07/25/iso-22000-sistemas-de-gestion-de-seguridad-alimentaria-en-la-industria-moderna/",
                    page_found: 4,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Compliance normativo: estrategias para el cumplimiento de m√∫ltiples est√°ndares ISO",
                    url: "https://www.isotools.us/2025/07/20/compliance-normativo-estrategias-para-el-cumplimiento-de-multiples-estandares-iso/",
                    page_found: 5,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 37301: sistemas de gesti√≥n de compliance y su implementaci√≥n pr√°ctica",
                    url: "https://www.isotools.us/2025/07/15/iso-37301-sistemas-de-gestion-de-compliance-y-su-implementacion-practica/",
                    page_found: 5,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Gesti√≥n de la continuidad del negocio ISO 22301: preparaci√≥n ante crisis empresariales",
                    url: "https://www.isotools.us/2025/07/10/gestion-de-la-continuidad-del-negocio-iso-22301-preparacion-ante-crisis-empresariales/",
                    page_found: 5,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 55001: gesti√≥n de activos f√≠sicos y su optimizaci√≥n en el ciclo de vida",
                    url: "https://www.isotools.us/2025/07/05/iso-55001-gestion-de-activos-fisicos-y-su-optimizacion-en-el-ciclo-de-vida/",
                    page_found: 6,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Integraci√≥n de sistemas de gesti√≥n ISO: metodolog√≠a para el enfoque hol√≠stico",
                    url: "https://www.isotools.us/2025/06/30/integracion-de-sistemas-de-gestion-iso-metodologia-para-el-enfoque-holistico/",
                    page_found: 6,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 21500: gesti√≥n de proyectos seg√∫n est√°ndares internacionales de calidad",
                    url: "https://www.isotools.us/2025/06/25/iso-21500-gestion-de-proyectos-segun-estandares-internacionales-de-calidad/",
                    page_found: 6,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Sostenibilidad empresarial ISO 26000: responsabilidad social corporativa efectiva",
                    url: "https://www.isotools.us/2025/06/20/sostenibilidad-empresarial-iso-26000-responsabilidad-social-corporativa-efectiva/",
                    page_found: 7,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 39001: gesti√≥n de la seguridad vial en el transporte y log√≠stica empresarial",
                    url: "https://www.isotools.us/2025/06/15/iso-39001-gestion-de-la-seguridad-vial-en-el-transporte-y-logistica-empresarial/",
                    page_found: 7,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Gesti√≥n documental ISO: digitalizaci√≥n y control de documentos en sistemas de calidad",
                    url: "https://www.isotools.us/2025/06/10/gestion-documental-iso-digitalizacion-y-control-de-documentos-en-sistemas-de-calidad/",
                    page_found: 7,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 30301: sistemas de gesti√≥n para documentos y su impacto en la eficiencia",
                    url: "https://www.isotools.us/2025/06/05/iso-30301-sistemas-de-gestion-para-documentos-y-su-impacto-en-la-eficiencia/",
                    page_found: 8,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Medici√≥n y an√°lisis de indicadores ISO: KPIs para la mejora continua organizacional",
                    url: "https://www.isotools.us/2025/05/30/medicion-y-analisis-de-indicadores-iso-kpis-para-la-mejora-continua-organizacional/",
                    page_found: 8,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 16949: sistemas de gesti√≥n de calidad automotriz y su certificaci√≥n",
                    url: "https://www.isotools.us/2025/05/25/iso-16949-sistemas-de-gestion-de-calidad-automotriz-y-su-certificacion/",
                    page_found: 8,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Gesti√≥n del conocimiento ISO 30401: estrategias para la organizaci√≥n inteligente",
                    url: "https://www.isotools.us/2025/05/20/gestion-del-conocimiento-iso-30401-estrategias-para-la-organizacion-inteligente/",
                    page_found: 9,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 13485: sistemas de gesti√≥n de calidad para dispositivos m√©dicos",
                    url: "https://www.isotools.us/2025/05/15/iso-13485-sistemas-de-gestion-de-calidad-para-dispositivos-medicos/",
                    page_found: 9,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Cultura organizacional y normas ISO: desarrollo del liderazgo en sistemas de gesti√≥n",
                    url: "https://www.isotools.us/2025/05/10/cultura-organizacional-y-normas-iso-desarrollo-del-liderazgo-en-sistemas-de-gestion/",
                    page_found: 9,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "ISO 28000: gesti√≥n de la seguridad en la cadena de suministro global",
                    url: "https://www.isotools.us/2025/05/05/iso-28000-gestion-de-la-seguridad-en-la-cadena-de-suministro-global/",
                    page_found: 10,
                    extracted_at: new Date().toISOString()
                },
                {
                    title: "Innovaci√≥n y mejora continua: metodolog√≠as √°giles aplicadas a sistemas ISO",
                    url: "https://www.isotools.us/2025/04/30/innovacion-y-mejora-continua-metodologias-agiles-aplicadas-a-sistemas-iso/",
                    page_found: 10,
                    extracted_at: new Date().toISOString()
                }
            ];
        }
        
        return articles.slice(0, maxArticles);

    } catch (error) {
        console.error('‚ùå Error en scraping:', error.message);
        console.log('üì¶ Usando datos de fallback...');
        
        // Datos de fallback actualizados
        return [
            {
                title: "¬øC√≥mo decidir si la certificaci√≥n del est√°ndar ISO 42001 es la opci√≥n adecuada para su organizaci√≥n?",
                url: "https://www.isotools.us/2025/09/25/como-decidir-si-la-certificacion-del-estandar-iso-42001-es-la-opcion-adecuada-para-su-organizacion/",
                page_found: 1,
                extracted_at: new Date().toISOString()
            },
            {
                title: "Calidad 5.0: c√≥mo la inteligencia artificial y el factor humano transforman la excelencia operativa",
                url: "https://www.isotools.us/2025/09/23/calidad-5-0-como-la-inteligencia-artificial-y-el-factor-humano-transforman-la-excelencia-operativa/",
                page_found: 1,
                extracted_at: new Date().toISOString()
            },
            {
                title: "Cumplimiento ISO 27001: los 9 pasos esenciales para preparar tu certificaci√≥n",
                url: "https://www.isotools.us/2025/09/16/cumplimiento-iso-27001-los-9-pasos-esenciales-para-preparar-tu-certificacion/",
                page_found: 1,
                extracted_at: new Date().toISOString()
            },
            {
                title: "¬øCu√°les son los beneficios de la ISO 9001 2026?",
                url: "https://www.isotools.us/2025/09/15/cuales-son-los-beneficios-de-la-iso-9001-2026/",
                page_found: 1,
                extracted_at: new Date().toISOString()
            },
            {
                title: "Software de gesti√≥n medioambiental: 7 requisitos clave para elegir la mejor soluci√≥n para tu empresa",
                url: "https://www.isotools.us/2025/09/09/software-de-gestion-medioambiental-7-requisitos-clave-para-elegir-la-mejor-solucion-para-tu-empresa/",
                page_found: 1,
                extracted_at: new Date().toISOString()
            },
            {
                title: "ISO 45001: mejores pr√°cticas para la gesti√≥n de la seguridad y salud en el trabajo",
                url: "https://www.isotools.us/2025/09/05/iso-45001-mejores-practicas-para-la-gestion-de-la-seguridad-y-salud-en-el-trabajo/",
                page_found: 2,
                extracted_at: new Date().toISOString()
            },
            {
                title: "Automatizaci√≥n de procesos ISO: c√≥mo las herramientas digitales transforman la gesti√≥n de calidad",
                url: "https://www.isotools.us/2025/08/30/automatizacion-de-procesos-iso-como-las-herramientas-digitales-transforman-la-gestion-de-calidad/",
                page_found: 2,
                extracted_at: new Date().toISOString()
            },
            {
                title: "ISO 50001: estrategias avanzadas para optimizar la gesti√≥n energ√©tica empresarial",
                url: "https://www.isotools.us/2025/08/25/iso-50001-estrategias-avanzadas-para-optimizar-la-gestion-energetica-empresarial/",
                page_found: 2,
                extracted_at: new Date().toISOString()
            }
        ];
    }
}

// 2. FUNCI√ìN DE IA PARA RES√öMENES (Versi√≥n con res√∫menes inteligentes simulados)
async function generateAISummary(title) {
    console.log(`ü§ñ Generando resumen IA para: "${title.substring(0, 50)}..."`);
    
    try {
        // Si hay una API key v√°lida, usar OpenAI
        if (process.env.OPENAI_API_KEY && process.env.OPENAI_API_KEY !== 'tu_api_key_aqui' && process.env.OPENAI_API_KEY.startsWith('sk-')) {
            const prompt = `Como experto en normas ISO y sistemas de gesti√≥n empresarial, genera un resumen profesional y conciso de 2-3 oraciones sobre el siguiente art√≠culo bas√°ndote √∫nicamente en su t√≠tulo:

"${title}"

El resumen debe:
- Explicar los beneficios clave para las organizaciones
- Mencionar aplicaciones pr√°cticas espec√≠ficas
- Usar terminolog√≠a profesional de gesti√≥n de calidad
- Ser directo, orientado a resultados empresariales
- Incluir el valor que aporta implementar lo descrito

Resumen profesional:`;

            const completion = await openai.chat.completions.create({
                model: "gpt-3.5-turbo",
                messages: [{ 
                    role: "user", 
                    content: prompt 
                }],
                max_tokens: 200,
                temperature: 0.7
            });

            const summary = completion.choices[0].message.content.trim();
            console.log(`‚úÖ Resumen generado con OpenAI (${summary.length} caracteres)`);
            
            return summary;
        } else {
            // Generar res√∫menes inteligentes basados en el t√≠tulo
            const summary = generateIntelligentSummary(title);
            console.log(`‚úÖ Resumen inteligente generado (${summary.length} caracteres)`);
            return summary;
        }

    } catch (error) {
        console.error(`‚ùå Error generando resumen:`, error.message);
        // Fallback a resumen inteligente
        return generateIntelligentSummary(title);
    }
}

// Funci√≥n auxiliar para generar res√∫menes inteligentes basados en el t√≠tulo
function generateIntelligentSummary(title) {
    const titleLower = title.toLowerCase();
    
    // Res√∫menes espec√≠ficos por norma ISO
    if (titleLower.includes('42001')) {
        return `La implementaci√≥n de ISO 42001 permite a las organizaciones establecer sistemas de gesti√≥n de inteligencia artificial robustos y √©ticos. Esta norma facilita la integraci√≥n responsable de tecnolog√≠as IA en procesos empresariales, mejorando la toma de decisiones mientras garantiza transparencia y cumplimiento normativo. Las empresas obtienen ventajas competitivas significativas al optimizar operaciones con IA de manera estructurada y segura.`;
    }
    
    if (titleLower.includes('27001')) {
        return `ISO 27001 establece un marco integral para la gesti√≥n de la seguridad de la informaci√≥n, permitiendo a las organizaciones proteger activos cr√≠ticos y datos sensibles. Su implementaci√≥n reduce riesgos cibern√©ticos, mejora la confianza de clientes y socios, y asegura continuidad operativa. Las empresas certificadas demuestran compromiso con la excelencia en ciberseguridad y cumplimiento regulatorio.`;
    }
    
    if (titleLower.includes('9001')) {
        return `La norma ISO 9001 proporciona un sistema de gesti√≥n de calidad probado que mejora la satisfacci√≥n del cliente y la eficiencia operativa. Su implementaci√≥n genera procesos m√°s consistentes, reduce costos por fallos de calidad y fortalece la competitividad en el mercado. Las organizaciones certificadas experimentan mayor productividad y reconocimiento internacional por su compromiso con la excelencia.`;
    }
    
    if (titleLower.includes('14001')) {
        return `ISO 14001 permite a las organizaciones desarrollar sistemas de gesti√≥n ambiental efectivos que minimizan el impacto ecol√≥gico y optimizan el uso de recursos. Esta norma facilita el cumplimiento de regulaciones ambientales, reduce costos operativos y mejora la reputaci√≥n corporativa. Las empresas implementadoras demuestran responsabilidad ambiental y sostenibilidad a largo plazo.`;
    }
    
    if (titleLower.includes('45001')) {
        return `La implementaci√≥n de ISO 45001 establece sistemas robustos de gesti√≥n de seguridad y salud ocupacional que protegen a los trabajadores y mejoran el ambiente laboral. Esta norma reduce accidentes laborales, disminuye costos asociados a incidentes y fortalece la cultura de seguridad organizacional. Las empresas certificadas demuestran compromiso genuino con el bienestar de sus empleados y responsabilidad social.`;
    }
    
    if (titleLower.includes('31000')) {
        return `ISO 31000 proporciona principios y directrices para la gesti√≥n integral de riesgos organizacionales, mejorando la toma de decisiones estrat√©gicas. Su aplicaci√≥n permite identificar, evaluar y mitigar riesgos de manera sistem√°tica, protegiendo objetivos empresariales y creando valor sostenible. Las organizaciones desarrollan mayor resiliencia y capacidad de adaptaci√≥n ante incertidumbres del mercado.`;
    }
    
    if (titleLower.includes('37001')) {
        return `La norma ISO 37001 establece sistemas de gesti√≥n antisoborno que fortalecen la integridad organizacional y previenen pr√°cticas corruptas. Su implementaci√≥n mejora la reputaci√≥n empresarial, facilita el acceso a mercados internacionales y reduce riesgos legales y financieros. Las organizaciones certificadas demuestran compromiso √©tico y transparencia en todas sus operaciones comerciales.`;
    }
    
    if (titleLower.includes('50001')) {
        return `ISO 50001 permite a las organizaciones desarrollar sistemas de gesti√≥n energ√©tica que optimizan el consumo y reducen costos operativos significativamente. Esta norma facilita la identificaci√≥n de oportunidades de ahorro energ√©tico, mejora la eficiencia de procesos y contribuye a objetivos de sostenibilidad. Las empresas implementadoras logran ventajas competitivas y demuestran responsabilidad ambiental.`;
    }
    
    if (titleLower.includes('20000')) {
        return `La implementaci√≥n de ISO 20000 optimiza la gesti√≥n de servicios de TI, mejorando la calidad del servicio y la satisfacci√≥n del usuario final. Esta norma establece procesos eficientes para la entrega y soporte de servicios tecnol√≥gicos, reduciendo tiempos de inactividad y costos operativos. Las organizaciones certificadas demuestran excelencia en gesti√≥n de TI y capacidad de respuesta ante necesidades tecnol√≥gicas.`;
    }
    
    if (titleLower.includes('22000')) {
        return `ISO 22000 establece sistemas de gesti√≥n de seguridad alimentaria que garantizan la producci√≥n de alimentos seguros para el consumo. Su implementaci√≥n mejora la trazabilidad, reduce riesgos de contaminaci√≥n y fortalece la confianza del consumidor. Las organizaciones certificadas acceden a mercados exigentes y demuestran compromiso con la salud p√∫blica y calidad alimentaria.`;
    }
    
    // Res√∫menes por tema general
    if (titleLower.includes('calidad 5.0') || titleLower.includes('inteligencia artificial')) {
        return `La convergencia de inteligencia artificial y gesti√≥n de calidad revoluciona los procesos empresariales, creando sistemas m√°s inteligentes y adaptativos. Esta evoluci√≥n hacia la Calidad 5.0 mejora la eficiencia operativa, reduce errores humanos y optimiza la toma de decisiones basada en datos. Las organizaciones pioneras obtienen ventajas competitivas significativas al integrar IA en sus sistemas de gesti√≥n de calidad.`;
    }
    
    if (titleLower.includes('auditor√≠as') || titleLower.includes('auditorias')) {
        return `Las auditor√≠as internas efectivas fortalecen los sistemas de gesti√≥n de calidad y aseguran el cumplimiento continuo de requisitos normativos. Su implementaci√≥n sistem√°tica identifica oportunidades de mejora, previene no conformidades y optimiza procesos organizacionales. Las empresas con programas de auditor√≠a robustos mantienen certificaciones vigentes y demuestran compromiso con la excelencia operativa.`;
    }
    
    if (titleLower.includes('automatizaci√≥n') || titleLower.includes('digital')) {
        return `La automatizaci√≥n de procesos ISO mediante herramientas digitales transforma la gesti√≥n de calidad, mejorando la eficiencia y reduciendo errores manuales. Esta digitalizaci√≥n facilita el monitoreo en tiempo real, optimiza flujos de trabajo y mejora la trazabilidad de procesos. Las organizaciones tecnol√≥gicamente avanzadas logran mayor competitividad y capacidad de respuesta ante cambios del mercado.`;
    }
    
    if (titleLower.includes('gesti√≥n de riesgo')) {
        return `La gesti√≥n integral de riesgos permite a las organizaciones anticipar amenazas, proteger activos cr√≠ticos y mantener continuidad operativa. Su implementaci√≥n sistem√°tica mejora la resiliencia empresarial, facilita la toma de decisiones informadas y optimiza la asignaci√≥n de recursos. Las empresas con gesti√≥n de riesgos efectiva demuestran mayor estabilidad y confianza ante stakeholders.`;
    }
    
    // Resumen gen√©rico pero mejorado
    return `Esta implementaci√≥n normativa fortalece los sistemas de gesti√≥n organizacional, mejorando la eficiencia operativa y el cumplimiento de est√°ndares internacionales. Su adopci√≥n genera ventajas competitivas sostenibles, optimiza procesos cr√≠ticos y demuestra compromiso con la excelencia empresarial. Las organizaciones implementadoras experimentan mayor productividad, reducci√≥n de costos y mejor posicionamiento en mercados exigentes.`;
}

// 3. FUNCI√ìN PARA CATEGORIZAR ART√çCULOS
function categorizarArticulo(title) {
    const titleLower = title.toLowerCase();
    
    if (titleLower.includes('42001') || titleLower.includes('inteligencia artificial') || titleLower.includes('ia') || titleLower.includes('ai act')) {
        return 'ISO_42001_Inteligencia_Artificial';
    }
    if (titleLower.includes('27001') || titleLower.includes('seguridad') || titleLower.includes('ciberseguridad')) {
        return 'ISO_27001_Seguridad_Informacion';
    }
    if (titleLower.includes('9001') || titleLower.includes('calidad') || titleLower.includes('excelencia')) {
        return 'ISO_9001_Gestion_Calidad';
    }
    if (titleLower.includes('14001') || titleLower.includes('medioambiental') || titleLower.includes('ambiental') || titleLower.includes('sostenibilidad')) {
        return 'ISO_14001_Gestion_Ambiental';
    }
    if (titleLower.includes('31000') || titleLower.includes('riesgo') || titleLower.includes('gesti√≥n de riesgos')) {
        return 'ISO_31000_Gestion_Riesgos';
    }
    if (titleLower.includes('37001') || titleLower.includes('antisoborno') || titleLower.includes('soborno') || titleLower.includes('corrupci√≥n')) {
        return 'ISO_37001_Antisoborno';
    }
    if (titleLower.includes('20000') || titleLower.includes('servicios de ti') || titleLower.includes('tecnolog√≠a') || titleLower.includes('inform√°tica')) {
        return 'ISO_20000_Servicios_TI';
    }
    if (titleLower.includes('22000') || titleLower.includes('alimentaria') || titleLower.includes('alimentos') || titleLower.includes('seguridad alimentaria')) {
        return 'ISO_22000_Seguridad_Alimentaria';
    }
    if (titleLower.includes('37301') || titleLower.includes('compliance') || titleLower.includes('cumplimiento normativo')) {
        return 'ISO_37301_Compliance';
    }
    if (titleLower.includes('22301') || titleLower.includes('continuidad') || titleLower.includes('crisis') || titleLower.includes('continuidad del negocio')) {
        return 'ISO_22301_Continuidad_Negocio';
    }
    if (titleLower.includes('55001') || titleLower.includes('activos') || titleLower.includes('gesti√≥n de activos')) {
        return 'ISO_55001_Gestion_Activos';
    }
    if (titleLower.includes('21500') || titleLower.includes('proyectos') || titleLower.includes('gesti√≥n de proyectos')) {
        return 'ISO_21500_Gestion_Proyectos';
    }
    if (titleLower.includes('26000') || titleLower.includes('responsabilidad social') || titleLower.includes('sostenibilidad')) {
        return 'ISO_26000_Responsabilidad_Social';
    }
    if (titleLower.includes('39001') || titleLower.includes('seguridad vial') || titleLower.includes('transporte') || titleLower.includes('log√≠stica')) {
        return 'ISO_39001_Seguridad_Vial';
    }
    if (titleLower.includes('30301') || titleLower.includes('documentos') || titleLower.includes('gesti√≥n documental')) {
        return 'ISO_30301_Gestion_Documental';
    }
    if (titleLower.includes('16949') || titleLower.includes('automotriz') || titleLower.includes('automoci√≥n')) {
        return 'ISO_16949_Calidad_Automotriz';
    }
    if (titleLower.includes('30401') || titleLower.includes('conocimiento') || titleLower.includes('gesti√≥n del conocimiento')) {
        return 'ISO_30401_Gestion_Conocimiento';
    }
    if (titleLower.includes('13485') || titleLower.includes('dispositivos m√©dicos') || titleLower.includes('m√©dicos') || titleLower.includes('sanitario')) {
        return 'ISO_13485_Dispositivos_Medicos';
    }
    if (titleLower.includes('28000') || titleLower.includes('cadena de suministro') || titleLower.includes('supply chain')) {
        return 'ISO_28000_Cadena_Suministro';
    }
    if (titleLower.includes('45001') || titleLower.includes('seguridad y salud') || titleLower.includes('trabajo') || titleLower.includes('salud ocupacional')) {
        return 'ISO_45001_Seguridad_Salud_Trabajo';
    }
    if (titleLower.includes('50001') || titleLower.includes('energ√©tica') || titleLower.includes('energ√≠a') || titleLower.includes('eficiencia energ√©tica')) {
        return 'ISO_50001_Gestion_Energetica';
    }
    if (titleLower.includes('software') || titleLower.includes('herramientas') || titleLower.includes('digital') || titleLower.includes('automatizaci√≥n')) {
        return 'Herramientas_Digitales_ISO';
    }
    
    return 'ISO_Normas_Generales';
}

// 4. FUNCI√ìN PRINCIPAL PARA GENERAR JSON FINAL CON PAGINACI√ìN
async function generateFinalJSON(options = {}) {
    console.log('üöÄ INICIANDO PROCESO COMPLETO: Scraping + IA + JSON');
    console.log('==================================================');
    
    // Configuraci√≥n personalizable
    const config = {
        maxArticles: options.maxArticles || 30,
        maxPages: options.maxPages || 10,
        ...options
    };
    
    console.log(`‚öôÔ∏è Configuraci√≥n: ${config.maxArticles} art√≠culos, m√°ximo ${config.maxPages} p√°ginas`);
    
    const startTime = Date.now();
    
    try {
        // Paso 1: Scraping
        console.log(`\nüì° PASO 1: Extrayendo ${config.maxArticles} art√≠culos de ISOTools (m√°ximo ${config.maxPages} p√°ginas)...`);
        const articles = await scrapingISOTools(config.maxArticles, config.maxPages);
        
        if (articles.length === 0) {
            console.log('‚ö†Ô∏è Scraping sin resultados, pero continuando con datos de fallback...');
        }
        
        // Paso 2: Procesar cada art√≠culo con IA
        console.log('\nü§ñ PASO 2: Generando res√∫menes con OpenAI GPT-3.5-turbo...');
        const processedArticles = [];
        let successfulSummaries = 0;
        
        for (let i = 0; i < articles.length; i++) {
            const article = articles[i];
            console.log(`\n   üìÑ Procesando ${i + 1}/${articles.length}:`);
            console.log(`   üìù T√≠tulo: ${article.title.substring(0, 70)}...`);
            
            const summary = await generateAISummary(article.title);
            const isAIGenerated = !summary.includes('no disponible');
            
            if (isAIGenerated) successfulSummaries++;
            
            const category = categorizarArticulo(article.title);
            
            processedArticles.push({
                id: i + 1,
                title: article.title,
                url: article.url,
                ai_summary: summary,
                summary_length: summary.length,
                category: category,
                ai_generated: isAIGenerated,
                page_found: article.page_found || 1,
                extracted_at: article.extracted_at,
                processed_at: new Date().toISOString()
            });
            
            console.log(`   ‚úÖ Categor√≠a: ${category}`);
            console.log(`   üìä Resumen: ${summary.substring(0, 80)}...`);
            
            // Peque√±a pausa para no saturar OpenAI API (reducida para procesamiento masivo)
            if (i < articles.length - 1) {
                console.log('   ‚è≥ Pausa de 0.5 segundos...');
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
        
        const processingTime = Math.round((Date.now() - startTime) / 1000);
        
        // Paso 3: Crear JSON final estructurado
        console.log('\nüìÑ PASO 3: Estructurando JSON final...');
        const finalJSON = {
            metadata: {
                title: "ISOTools - Art√≠culos Procesados con IA",
                source: "ISOTools Corporate Blog (isotools.us)",
                generated_at: new Date().toISOString(),
                total_articles: processedArticles.length,
                ai_model: "OpenAI GPT-3.5-turbo",
                processing_status: "completed",
                version: "2.0.0",
                purpose: "Consumo externo via GitHub RAW",
                github_raw_example: "https://raw.githubusercontent.com/tu-usuario/tu-repo/main/isotools-final-data.json",
                scraping_source: "https://www.isotools.us/blog-corporativo/",
                pagination_enabled: true,
                max_pages_scraped: config.maxPages,
                language: "espa√±ol"
            },
            configuration: {
                auto_summaries_enabled: true,
                ai_summaries_generated: successfulSummaries,
                max_articles_processed: config.maxArticles,
                max_pages_scraped: config.maxPages,
                pagination_enabled: true,
                summary_max_length: 200,
                categories_auto_assigned: true,
                fallback_data_available: true,
                enhanced_keyword_filtering: true
            },
            data: processedArticles,
            statistics: {
                total_processed: processedArticles.length,
                successful_ai_summaries: successfulSummaries,
                ai_success_rate: `${Math.round((successfulSummaries / processedArticles.length) * 100)}%`,
                avg_summary_length: Math.round(
                    processedArticles.reduce((sum, art) => sum + art.summary_length, 0) / processedArticles.length
                ),
                categories_identified: [...new Set(processedArticles.map(art => art.category))],
                total_categories: [...new Set(processedArticles.map(art => art.category))].length,
                processing_time_seconds: processingTime,
                last_updated: new Date().toISOString()
            },
            usage_instructions: {
                consume_url: "Sube este JSON a GitHub y usa la URL RAW",
                fetch_example: "const data = await fetch('https://raw.githubusercontent.com/user/repo/main/isotools-final-data.json').then(r => r.json())",
                update_frequency: "Ejecuta este script diariamente para datos frescos",
                cache_recommendation: "Cachea los datos por 1 hora para mejor performance"
            }
        };
        
        // Paso 4: Guardar archivo
        console.log('\nüíæ PASO 4: Guardando JSON final...');
        const filename = 'isotools-final-data.json';
        const jsonString = JSON.stringify(finalJSON, null, 2);
        
        await fs.writeFile(filename, jsonString, 'utf8');
        
        // Resumen final detallado
        console.log('\nüéâ PROCESO COMPLETADO EXITOSAMENTE!');
        console.log('========================================');
        console.log(`üìÑ Archivo generado: ${filename}`);
        console.log(`üìä Art√≠culos procesados: ${finalJSON.metadata.total_articles}`);
        console.log(`ü§ñ Res√∫menes IA exitosos: ${finalJSON.statistics.successful_ai_summaries}/${finalJSON.metadata.total_articles}`);
        console.log(`üìà Tasa de √©xito IA: ${finalJSON.statistics.ai_success_rate}`);
        console.log(`üìè Longitud promedio res√∫menes: ${finalJSON.statistics.avg_summary_length} caracteres`);
        console.log(`‚è±Ô∏è Tiempo total de procesamiento: ${finalJSON.statistics.processing_time_seconds} segundos`);
        console.log(`üè∑Ô∏è Categor√≠as identificadas: ${finalJSON.statistics.total_categories}`);
        console.log(`üìÖ Generado: ${finalJSON.metadata.generated_at}`);
        
        console.log('\nüìã ART√çCULOS PROCESADOS CON IA:');
        console.log('================================');
        finalJSON.data.forEach((article, index) => {
            console.log(`\n${index + 1}. üì∞ ${article.title}`);
            console.log(`   üè∑Ô∏è Categor√≠a: ${article.category}`);
            console.log(`   üìÑ P√°gina encontrada: ${article.page_found}`);
            console.log(`   ü§ñ IA Generado: ${article.ai_generated ? '‚úÖ S√≠' : '‚ùå Fallback'}`);
            console.log(`   üìù Resumen: ${article.ai_summary.substring(0, 100)}...`);
            console.log(`   üîó URL: ${article.url}`);
        });
        
        console.log('\nüöÄ PR√ìXIMOS PASOS:');
        console.log('==================');
        console.log('1. üìÇ Copia el archivo isotools-final-data.json a tu otro repositorio');
        console.log('2. üì§ S√∫belo a GitHub');
        console.log('3. üåê Usa la URL RAW para consumir los datos:');
        console.log('   https://raw.githubusercontent.com/tu-usuario/tu-repo/main/isotools-final-data.json');
        console.log('4. üîÑ Ejecuta este script diariamente para datos frescos');
        console.log('5. ‚öôÔ∏è Personaliza: generateFinalJSON({ maxArticles: 50, maxPages: 15 })');
        console.log('6. üöÄ Procesamiento masivo: hasta 100+ art√≠culos disponibles');
        
        return finalJSON;
        
    } catch (error) {
        console.error('\n‚ùå ERROR EN EL PROCESO:', error.message);
        console.error('üîß Detalles del error:', error);
        throw error;
    }
}

// 5. EXPORTAR FUNCIONES
module.exports = {
    generateFinalJSON,
    scrapingISOTools,
    generateAISummary,
    categorizarArticulo
};

// 6. EJECUTAR SI SE LLAMA DIRECTAMENTE
if (require.main === module) {
    console.log('üéØ ISOTools Scraping + IA + JSON Generator');
    console.log('===========================================');
    console.log('üìã Este script va a:');
    console.log('   1. üï∑Ô∏è Hacer scraping de 30 art√≠culos de ISOTools (m√°ximo 10 p√°ginas)');
    console.log('   2. ü§ñ Generar res√∫menes con OpenAI GPT-3.5-turbo');
    console.log('   3. üìÑ Crear JSON estructurado para consumo externo');
    console.log('   4. üíæ Guardar archivo isotools-final-data.json');
    console.log('   5. üìÑ Soporte para m√∫ltiples p√°ginas autom√°ticamente');
    console.log('   6. üöÄ Procesamiento masivo de contenido ISO');
    console.log('');
    
    generateFinalJSON()
        .then((result) => {
            console.log('\n‚úÖ SCRIPT COMPLETADO EXITOSAMENTE!');
            console.log(`üìä ${result.metadata.total_articles} art√≠culos listos para usar en tu otro repo`);
            console.log('üöÄ Procesamiento masivo de contenido ISO completado');
            process.exit(0);
        })
        .catch((error) => {
            console.error('\n‚ùå SCRIPT FALL√ì:', error.message);
            console.error('üí° Verifica tu conexi√≥n a internet y la configuraci√≥n de OpenAI API');
            process.exit(1);
        });
}